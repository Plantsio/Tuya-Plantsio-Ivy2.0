<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TuyaOS: KV-DB</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TuyaOS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'搜索','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','搜索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">KV-DB </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >物联网平台碎片化严重，各种各样的芯片和操作系统，资源、能力差异非常大。但是物联网设备的存储需求又有非常高的安全性，因为涉及到用户的隐私问题；要有非常高的可靠性，因为客户的场景不可控，必须在各种极端的情况下保证用户设备的可用性；还要有性能的要求，保证用户的使用体验。涂鸦<code>TuyaOS</code>提供了KV DB支持在文件系统、Flash上实现一套基于Key-Value存储的加密数据库，屏蔽了底层介质、操作系统的差异，为开发者提供了安全、可靠、高效的数据存储服务。</p>
<h1><a class="anchor" id="autotoc_md55"></a>
接口描述</h1>
<h2><a class="anchor" id="autotoc_md56"></a>
KV DB写入</h2>
<p >向KV DB写入一组Key-Value数据，需要提供key、value以及value的长度。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ab07c8df9f6221ba7ca202a35919cacc3">wd_common_write</a>(IN CONST CHAR_T *key, IN CONST BYTE_T *value, IN CONST UINT_T len);</div>
<div class="ttc" id="atuya__ws__db_8h_html_ab07c8df9f6221ba7ca202a35919cacc3"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#ab07c8df9f6221ba7ca202a35919cacc3">wd_common_write</a></div><div class="ttdeci">OPERATE_RET wd_common_write(IN CONST CHAR_T *key, IN CONST BYTE_T *value, IN CONST UINT_T len)</div><div class="ttdoc">tuya key-value database write entry</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md57"></a>
KV DB读取</h2>
<p >从KV DB中读取一组Key-Value数据，需要提供key，并提供一个用于存储value的缓冲区和缓冲区的长度，读取成功之后获得value以及value的长度。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a92309aef28c9d07694f368c2f5684958">wd_common_read</a>(IN CONST CHAR_T *key, OUT BYTE_T **value, OUT UINT_T *p_len);</div>
<div class="ttc" id="atuya__ws__db_8h_html_a92309aef28c9d07694f368c2f5684958"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#a92309aef28c9d07694f368c2f5684958">wd_common_read</a></div><div class="ttdeci">OPERATE_RET wd_common_read(IN CONST CHAR_T *key, OUT BYTE_T **value, OUT UINT_T *p_len)</div><div class="ttdoc">tuya key-value database read entry</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md58"></a>
KV DB删除数据</h2>
<p >从KV DB中删除一组Key-Value数据，需要提供key。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a211e0fcc239b157a6805b0f2593b10a3">wd_common_delete</a>(IN CONST CHAR_T *key);</div>
<div class="ttc" id="atuya__ws__db_8h_html_a211e0fcc239b157a6805b0f2593b10a3"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#a211e0fcc239b157a6805b0f2593b10a3">wd_common_delete</a></div><div class="ttdeci">OPERATE_RET wd_common_delete(IN CONST CHAR_T *key)</div><div class="ttdoc">delete the entry from key-value database</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md59"></a>
KV DB模糊读取</h2>
<p >使用模糊匹配的方式，从KV DB中读取一组符合包含key的Key-Value数据，需要提供fuzzy key（key的子段），并提供一个用于存储value的缓冲区和缓冲区的长度，读取成功之后获得value以及value的长度，wd_common_fuzzy_read会按照查找的index逐个返回查找命中的Key-Value数据。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ac9aeb6e9428dbb825c53856a450f251a">wd_common_fuzzy_read</a>(IN CONST CHAR_T *fuzzy_name, INOUT UINT_T *index, OUT BYTE_T **data, OUT UINT_T *len);</div>
<div class="ttc" id="atuya__ws__db_8h_html_ac9aeb6e9428dbb825c53856a450f251a"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#ac9aeb6e9428dbb825c53856a450f251a">wd_common_fuzzy_read</a></div><div class="ttdeci">OPERATE_RET wd_common_fuzzy_read(IN CONST CHAR_T *fuzzy_name, INOUT UINT_T *index, OUT BYTE_T **data, OUT UINT_T *len)</div><div class="ttdoc">tuya key-value database fuzzy read entry</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md60"></a>
KV DB模糊删除数据</h3>
<p >使用模糊匹配的方式，从KV DB中删除一组符合包含key的Key-Value数据，需要提供fuzzy key（key的子段）。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a0d780cf8b1364edb469700506b76f7c0">wd_common_fuzzy_delete</a>(IN CONST CHAR_T *key);</div>
<div class="ttc" id="atuya__ws__db_8h_html_a0d780cf8b1364edb469700506b76f7c0"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#a0d780cf8b1364edb469700506b76f7c0">wd_common_fuzzy_delete</a></div><div class="ttdeci">OPERATE_RET wd_common_fuzzy_delete(IN CONST CHAR_T *key)</div><div class="ttdoc">fuzzy delete the entry from key-value database</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md61"></a>
KV DB模糊读取数据释放</h3>
<p >释放wd_common_read和wd_common_fuzzy_read时申请的资源，注意，在使用wd_common_read和wd_common_fuzzy_read成功之后，必须调用wd_common_free_data接口，否则会造成内存泄露。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#acf74d898a9063854bda275df8691eeba">wd_common_free_data</a>(IN BYTE_T *data);</div>
<div class="ttc" id="atuya__ws__db_8h_html_acf74d898a9063854bda275df8691eeba"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#acf74d898a9063854bda275df8691eeba">wd_common_free_data</a></div><div class="ttdeci">OPERATE_RET wd_common_free_data(IN BYTE_T *data)</div><div class="ttdoc">free the buffer which allocated by wd_common_read or wd_common_fuzzy_read</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md62"></a>
KV DB写入用户自定义数据</h2>
<p >专门用于key "user_param_key"写入的接口，"user_param_key"是一个专用于开发者自定义数据存储的key。因此不需要输入key。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a784ac3c50cf8c527dc33763ce962fa1c">wd_user_param_write</a>(IN CONST BYTE_T *data, IN CONST UINT_T len);</div>
<div class="ttc" id="atuya__ws__db_8h_html_a784ac3c50cf8c527dc33763ce962fa1c"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#a784ac3c50cf8c527dc33763ce962fa1c">wd_user_param_write</a></div><div class="ttdeci">OPERATE_RET wd_user_param_write(IN CONST BYTE_T *data, IN CONST UINT_T len)</div><div class="ttdoc">write the user parameter to tuya key-value database</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md63"></a>
KV DB读取用户自定义数据</h2>
<p >专门用于key "user_param_key"读取的接口，"user_param_key"是一个专用于开发者自定义数据存储的key。因此不需要输入key。 </p><div class="fragment"><div class="line"> </div>
<div class="line">OPERATE_RET <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a11583ff5eee8276eaa9bb653a99bc30d">wd_user_param_read</a>(OUT BYTE_T **buf, OUT UINT_T *len);</div>
<div class="ttc" id="atuya__ws__db_8h_html_a11583ff5eee8276eaa9bb653a99bc30d"><div class="ttname"><a href="../../d2/d13/tuya__ws__db_8h.html#a11583ff5eee8276eaa9bb653a99bc30d">wd_user_param_read</a></div><div class="ttdeci">OPERATE_RET wd_user_param_read(OUT BYTE_T **buf, OUT UINT_T *len)</div><div class="ttdoc">read the user parameter from tuya key-value database</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md64"></a>
示例代码</h1>
<div class="fragment"><div class="line">sample_kv_demo()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> rt = OPRT_OK;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 写一个数据&quot;ddi-xxx&quot;：&quot;hello-world-x&quot;</span></div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ab07c8df9f6221ba7ca202a35919cacc3">wd_common_write</a>(<span class="stringliteral">&quot;ddi-xxx&quot;</span>, <span class="stringliteral">&quot;hello-world-x&quot;</span>, 13);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 读取数据&quot;ddi-xxx&quot;，需要wd_common_free_data</span></div>
<div class="line">    BYTE_T *value = NULL;</div>
<div class="line">    UINT_T len = 0;</div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a92309aef28c9d07694f368c2f5684958">wd_common_read</a>(<span class="stringliteral">&quot;ddi-xxx&quot;</span>, &amp;value, &amp;len);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line">    EXPECT_EQ(memcmp(value, <span class="stringliteral">&quot;hello-world-x&quot;</span>, 13), 0);</div>
<div class="line">    <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#acf74d898a9063854bda275df8691eeba">wd_common_free_data</a>(value);</div>
<div class="line">    value = NULL;</div>
<div class="line">    len = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 写一个数据&quot;ddi-xxx&quot;：&quot;hello-world-y&quot;</span></div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ab07c8df9f6221ba7ca202a35919cacc3">wd_common_write</a>(<span class="stringliteral">&quot;ddi-yyy&quot;</span>, <span class="stringliteral">&quot;hello-world-y&quot;</span>, 13);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 修改数据&quot;ddi-xxx&quot;：&quot;hello-world-z&quot;</span></div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ab07c8df9f6221ba7ca202a35919cacc3">wd_common_write</a>(<span class="stringliteral">&quot;ddi-xxx&quot;</span>, <span class="stringliteral">&quot;hello-world-z&quot;</span>, 13);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 读取所有包含&quot;ddi-&quot;的数据，会自动迭代读取全部数据</span></div>
<div class="line">    UINT index = 0;</div>
<div class="line">    <span class="keywordflow">while</span>(rt == OPRT_OK) {</div>
<div class="line">        rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#ac9aeb6e9428dbb825c53856a450f251a">wd_common_fuzzy_read</a>(<span class="stringliteral">&quot;ddi-&quot;</span>, &amp;index, &amp;value, &amp;len);</div>
<div class="line">        <span class="keywordflow">if</span>(value) {</div>
<div class="line">            <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#acf74d898a9063854bda275df8691eeba">wd_common_free_data</a>(value);</div>
<div class="line">            value = NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 删除数据&quot;ddi-xxx&quot;</span></div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a211e0fcc239b157a6805b0f2593b10a3">wd_common_delete</a>(<span class="stringliteral">&quot;ddi-xxx&quot;</span>);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 删除所有包含&quot;ddi-&quot;的数据</span></div>
<div class="line">    rt = <a class="code hl_function" href="../../d2/d13/tuya__ws__db_8h.html#a0d780cf8b1364edb469700506b76f7c0">wd_common_fuzzy_delete</a>(<span class="stringliteral">&quot;ddi-&quot;</span>);</div>
<div class="line">    EXPECT_EQ(rt, OPRT_OK);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> OPRT_OK;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
制作者&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
