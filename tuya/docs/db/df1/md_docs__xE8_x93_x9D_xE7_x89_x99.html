<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TuyaOS: 蓝牙</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TuyaOS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'搜索','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','搜索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">蓝牙 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >涂鸦<code>TuyaOS</code>支持蓝牙作为一个近场通信的功能，和<code>Powered by Tuya</code>设备进行配对、连接，建立蓝牙通道，并对设备进行蓝牙配网、蓝牙激活、蓝牙控制、蓝牙校时、蓝牙遥控器、蓝牙定时、蓝牙产测等功能。</p>
<h1><a class="anchor" id="autotoc_md40"></a>
蓝牙配网</h1>
<p >未配网设备发送蓝牙广播，涂鸦智能APP在接收到蓝牙广播数据之后，会对未配网设备发起配对，配对完成之后，根据涂鸦蓝牙协议进行配网交互，涂鸦智能APP向云端申请<code>Token</code>，并将<code>SSID</code>、<code>Password</code>和<code>Token</code>发送给待配网设备。待配网设备拿到<code>SSID</code>、<code>Password</code>和<code>Token</code>之后，连接<code>Wi-Fi</code>路由器，并连接涂鸦<code>IoT</code>平台，进行激活绑定。</p>
<p >蓝牙配网功能不需要客户进行编码，涂鸦<code>TuyaOS</code>直接提供了相关的能力。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md41"></a>
蓝牙激活</h1>
<p >此功能包括蓝牙兜底激活、连云激活功能。作为配网的兜底方案，设备在蓝牙配网失败时，会触发兜底激活，即通过涂鸦智能APP代理连云激活，以实现设备在无网的情况下可以对设备进行dp控制等业务功能；当设备有网络，且已经兜底激活时，用户可以进一步操作连云激活功能，涂鸦智能APP设置<code>SSID</code>、<code>Password</code>信息并发送给设备，设备拿到<code>SSID</code>、<code>Password</code>信息后，连接<code>Wi-Fi</code>路由器，并且正常连云，此时设备状态和普通蓝牙/WIFI配网结果状态一致。</p>
<p >蓝牙激活功能不需要客户进行编码，涂鸦<code>TuyaOS</code>直接提供了相关的能力。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md42"></a>
蓝牙控制</h1>
<p >蓝牙控制，即设备提供了蓝牙链路的DP控制功能，包括DP上报、下发、DP查询功能。</p>
<p >蓝牙控制涉及客户的DP业务，可参考DP功能描述中的蓝牙相关部分。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md43"></a>
蓝牙校时</h1>
<p >当蓝牙连接建立的时候，通过涂鸦蓝牙协议，对设备进行时间校准。</p>
<p >蓝牙校时功能不需要客户进行编码，涂鸦<code>TuyaOS</code>直接提供了相关的能力。</p>
<h1><a class="anchor" id="autotoc_md44"></a>
蓝牙遥控器</h1>
<p >蓝牙遥控器需要<code>Powered by Tuya</code>设备开启蓝牙扫描能力。蓝牙遥控器当前支持线上和线下两个版本。线上版本，蓝牙遥控器在绑定设备时，蓝牙遥控器和<code>Powered by Tuya</code>设备必须已配网，且配在相同家庭下；<code>Powered by Tuya</code>设备需要从涂鸦IoT平台获取<code>beacon_key</code>，用于蓝牙遥控协议数据的解密。线下版本，即遥控器绑定设备时，设备没有必须已配网的限制，蓝牙遥控器也无需配网，因此也称为免配网蓝牙beacon遥控器。</p>
<p >设备在接收到遥控器发送的蓝牙广播数据的时候，线上版本，会使用<code>beacon_key</code>对数据进行解密、过滤，线上版本会通过随机数特殊算法对数据进行解密、过滤，并将解密之后的数据发送给开发者，开发者根据蓝牙遥控器协议的定义，解析数据并执行相关的遥控操作。</p>
<p >蓝牙校时功能需要客户注册遥控器回调，从而实现客户的业务数据处理需求。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md45"></a>
蓝牙定时</h1>
<p >蓝牙定时，即<code>Powered by Tuya</code>设备提供蓝牙通道的定时器功能。此功能主要在设备无网场景时，涂鸦智能APP可以通过蓝牙通道，完成定时器任务功能。</p>
<p >蓝牙定时功能不需要客户进行编码，涂鸦<code>TuyaOS</code>直接提供了相关的能力。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md46"></a>
蓝牙产测</h1>
<p >蓝牙产测功能，即<code>Powered by Tuya</code>设备提供了蓝牙通道的产测功能，产测协议可参考涂鸦WIFI产测协议。客户如需增加产测内容，可以参考涂鸦产测相关功能介绍。</p>
<p >蓝牙产测功能不需要客户进行编码，涂鸦<code>TuyaOS</code>直接提供了相关的能力。此功能支持配置开关裁剪，也支持客户编码定制。</p>
<h1><a class="anchor" id="autotoc_md47"></a>
蓝牙功能定制</h1>
<p >此功能支持客户编码定制蓝牙各子功能。默认蓝牙功能全开。如果客户定制了蓝牙子功能，未使能的功能将不会被链接到固件BIN中，从而节省客户FLASH成本。</p>
<h1><a class="anchor" id="autotoc_md48"></a>
接口描述</h1>
<h2><a class="anchor" id="autotoc_md49"></a>
注册蓝牙遥控回调</h2>
<div class="fragment"><div class="line"><span class="comment">//callback function for advertisement scanning data processing</span></div>
<div class="line"><span class="keyword">typedef</span> VOID (*TUYA_BLE_APP_SCAN_HANDLE)(UCHAR_T *data, UCHAR_T len,  UCHAR_T type, UCHAR_T* mac);</div>
<div class="line"> </div>
<div class="line">OPERATE_RET tuya_ble_reg_app_scan_adv_cb(TUYA_BLE_APP_SCAN_HANDLE cb);</div>
</div><!-- fragment --><p >此接口用于注册蓝牙遥控功能的数据接收回调，其中<code>TUYA_BLE_APP_SCAN_HANDLE</code>为回调函数原型。注册该回调之后，设备会的确蓝牙扫描功能，并将接收到的蓝牙广播进行过滤，通过回调通知应用。</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    TUYA_BLE_OP_UNBIND = 0,</div>
<div class="line">    TUYA_BLE_OP_BIND,</div>
<div class="line">} <a class="code hl_enumeration" href="../../db/d24/tuya__bt_8h.html#ae8a2b021854325411bb3ca60bbe06102">TUYA_BLE_BIND_TYPE</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//callback function for validity check for bind or unbind operation</span></div>
<div class="line"><span class="keyword">typedef</span> OPERATE_RET(*BLE_SCAN_ADV_BIND_CHECK_CB)(<a class="code hl_enumeration" href="../../db/d24/tuya__bt_8h.html#ae8a2b021854325411bb3ca60bbe06102">TUYA_BLE_BIND_TYPE</a> type, UCHAR_T *data, UCHAR_T len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//callback function for result notify for bind or unbind operation</span></div>
<div class="line"><span class="keyword">typedef</span> VOID_T(*BLE_SCAN_ADV_BIND_RSLT_NOTIFY_CB)(<a class="code hl_enumeration" href="../../db/d24/tuya__bt_8h.html#ae8a2b021854325411bb3ca60bbe06102">TUYA_BLE_BIND_TYPE</a> type, <span class="keywordtype">int</span> rslt);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    BLE_SCAN_ADV_BIND_CHECK_CB       bind_check;</div>
<div class="line">    BLE_SCAN_ADV_BIND_RSLT_NOTIFY_CB bind_notify;</div>
<div class="line">} TUYA_BLE_SCAN_ADV_HANDLE_CBS;</div>
<div class="line"> </div>
<div class="line">OPERATE_RET tuya_ble_reg_app_scan_adv_handle_cbs(TUYA_BLE_SCAN_ADV_HANDLE_CBS* cbs);</div>
<div class="ttc" id="atuya__bt_8h_html_ae8a2b021854325411bb3ca60bbe06102"><div class="ttname"><a href="../../db/d24/tuya__bt_8h.html#ae8a2b021854325411bb3ca60bbe06102">TUYA_BLE_BIND_TYPE</a></div><div class="ttdeci">TUYA_BLE_BIND_TYPE</div><div class="ttdoc">bind type for bluetooth remote controller</div><div class="ttdef"><b>Definition:</b> tuya_bt.h:53</div></div>
</div><!-- fragment --><p >此接口用于注册蓝牙遥控器绑定、解绑时客户检查回调，以及绑定、解绑结果通知，以满足客户个性化需求。</p>
<div class="fragment"><div class="line">VOID_T tuya_ble_set_bind_window(UINT_T time_out);</div>
</div><!-- fragment --><p> 此接口用于设置蓝牙遥控器绑定时间窗，以满足客户个性化需求。参数为秒，最小时间窗为30s；如果传入为0，则表示时间窗常打开。设备在上电后会打开时间窗，只有在时间窗内可以绑定蓝牙遥控器。</p>
<div class="fragment"><div class="line">VOID_T tuya_ble_open_bind_window(VOID_T);</div>
</div><!-- fragment --><p> 此接口用于重新打开蓝牙遥控器绑定时间窗，以满足客户个性化需求。如电工设备，没有上电场景，因此需要其他方式来重新打开绑定时间窗，以支持绑定功能。</p>
<h3><a class="anchor" id="autotoc_md50"></a>
示例代码</h3>
<div class="fragment"><div class="line">STATIC VOID __bel_scan_handle(UCHAR_T *data, UCHAR_T len,  UCHAR_T type, UCHAR_T* mac)</div>
<div class="line">{</div>
<div class="line">    PR_DEBUG(<span class="stringliteral">&quot;recv ble remote cntl from %s&quot;</span>, mac);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// 在完成系统初始化之后调用此接口测试蓝牙遥控</span></div>
<div class="line">VOID test_ble_remote_cntl()</div>
<div class="line">{</div>
<div class="line">    tuya_ble_reg_app_scan_adv_cb(__bel_scan_handle);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md51"></a>
蓝牙功能定制</h2>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙基础能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_netcfg(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙配网能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_active(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙激活能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_dp_ctrl(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙dp控制能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_timer(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙定时能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_psk30(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙psk3.0能力</p>
<div class="fragment"><div class="line">VOID_T tuya_enable_ble_mftst(VOID_T);</div>
</div><!-- fragment --><p >此接口用于使能蓝牙产测能力</p>
<h3><a class="anchor" id="autotoc_md52"></a>
示例代码</h3>
<div class="fragment"><div class="line">VOID_T do_ble_tailor(VOID_T)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//蓝牙子功能，如不需要可以裁剪掉，功能则不会编入BIN中</span></div>
<div class="line">    tuya_enable_ble();<span class="comment">//基础蓝牙能力</span></div>
<div class="line">    tuya_enable_ble_dp_ctrl();<span class="comment">//dp控制能力</span></div>
<div class="line">    tuya_enable_ble_timer();<span class="comment">//蓝牙定时能力</span></div>
<div class="line">    tuya_enable_ble_netcfg();<span class="comment">//蓝牙配网能力</span></div>
<div class="line">    tuya_enable_ble_active();<span class="comment">//plug_play能力</span></div>
<div class="line"><span class="preprocessor">#if defined(TUYA_SECURITY_LEVEL) </span><span class="comment">//PSK能力</span></div>
<div class="line">    tuya_enable_ble_psk30();<span class="comment">//psk3.0，支持大数据通道的蓝牙配网、连云激活功能</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    tuya_enable_ble_mftst();<span class="comment">//蓝牙通道产测能力</span></div>
<div class="line">    <span class="comment">//蓝牙遥控器功能，通过tuya_ble_reg_app_scan_adv_cb在device_init中使能</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">VOID pre_device_init(VOID)</div>
<div class="line">{</div>
<div class="line">    ....</div>
<div class="line">    do_ble_tailor();<span class="comment">//蓝牙子功能裁剪</span></div>
<div class="line">    ....</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md53"></a>
注意事项</h3>
<p >1.应用需要在pre_device_init中（即TuyaOS初始化之前）先做蓝牙功能裁剪。 2.基础蓝牙能力必须打开后，再进行子功能裁剪。 3.子功能必须SDK蓝牙配置项打开前提下才能裁剪，否则接口将会找不到。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
制作者&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
